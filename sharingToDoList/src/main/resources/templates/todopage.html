<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="utf-8" />
  <!--<meta name=description content="This site was generated with Anima. www.animaapp.com"/>-->
  <!-- <link rel="shortcut icon" type=image/png href="https://animaproject.s3.amazonaws.com/home/favicon.png" /> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <link rel="shortcut icon" type="image/png" href="https://animaproject.s3.amazonaws.com/home/favicon.png" />
  <meta name="og:type" content="website" />
  <meta name="twitter:card" content="photo" />
  <link rel="stylesheet" type="text/css" href="/css/todopage.css" />
  <link rel="stylesheet" type="text/css" href="/css/styleguide.css" />
  <link rel="stylesheet" type="text/css" href="/css/globals.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
</head>
<body style="margin: 0; background: #ffffff">
<input type="hidden" id="anPageName" name="page" value="todopage" />
<div class="container-center-horizontal">
  <div class="todopage screen">
    <a href="mainpage" class="align-self-flex-start"
    ><img class="vector-1" src="/img/vector-2.svg" alt="Vector" />
    </a>
    <div class="frame-41">
      <div class="text-64 valign-text-middle" th:text="${challengeName}">"</div>
      <div class="text-63 valign-text-middle">ğŸŒŸìƒê¸ˆ: <span th:text="${challengePrize}"></span></div>
      <p class="text-65">06 : 36 : 59</p>
    </div>
    <div class="group-80">
      <!--         to- do list code -->
      <div class="group-container-1">
        <img class="group-2" src="/img/group-2@2x.png" alt="Group" />
        <div class="overlap-group4-2"><div class="text-73 valign-text-middle" th:text="${userNick}"></div></div>
<!--        <input type="button" class="searchBtn btn-all" value="ì „ì²´ : 0">-->
<!--        <input type="button" class="searchBtn btn-before" value="ì§„í–‰ì¤‘ : 0">-->
<!--        <input type="button" class="searchBtn btn-after" value="ì™„ë£Œ : 0">-->
      </div>

      <!-- Todo-List -->
      <div class="listBox">
        <!-- ì‚¬ìš©ìì˜ to-do-list -->
        <div class="addBox">
          <div class="addBox_inner">
            <input type="text" class="addTxt" placeholder="To-do list ì‘ì„±">
            <input type="button" class="addBtn" value="+">
          </div>
          <div class="currentUser">
          <ul class="listLb">
            <li th:each="todo : ${userTodos}"> <!--ì´ ì±Œë¦°ì§€ë¥¼ í•¨ê»˜í•˜ëŠ” ë©”ì´íŠ¸ì˜ to_do_list ë‚˜ì—´ -->
              <input type="checkbox" class="listCheck" th:checked="${todo.complete == 'ì™„ë£Œ'}">
              <span th:class="${todo.complete == 'ì™„ë£Œ'} ? 'completed-task' : 'incomplete-task'" th:text="${todo.details}"></span>
            </li>
          </ul>
          </div>
        </div>

        <!-- ì „ì²´ì„ íƒ/ì‚­ì œ -->
        <!--            <div class="allCheckBox">-->
        <!--              <label class="allSelect_lb"><input type="checkbox" class="allSelect">ì „ì²´ì„ íƒ</label>-->
        <!--              <a href="javascript:void(0)" class="allDel">ì „ì²´ì‚­ì œ</a>-->
        <!--            </div>-->

        <!-- ëª©ë¡ -->
        <div class="listBox_inner"></div>
      </div>
    </div>
    <div class="group-81">
      <div class="group-container-1">
        <img class="group-2" src="/img/group-2@2x.png" alt="Group" />
        <div class="overlap-group4-1"><div class="text-73 valign-text-middle" th:text="${mymateNick}"></div></div>
      </div>

    </div>
    <ul class="listLb">
      <li th:each="task : ${todoItems}"> <!--ì´ ì±Œë¦°ì§€ë¥¼ í•¨ê»˜í•˜ëŠ” ë©”ì´íŠ¸ì˜ to_do_list ë‚˜ì—´ -->
        <input type="checkbox" class="listCheck" th:checked="${task.complete == 'ì™„ë£Œ'}" disabled>
        <span th:class="${task.complete == 'ì™„ë£Œ'} ? 'completed-task' : 'incomplete-task'" th:text="${task.details}"></span>
      </li>
    </ul>
  </div>
</div>
</body>
<script>
  let addBtn = document.querySelector('.addBtn')
let addTxt = document.querySelector('.addTxt')
let listBox_inner = document.querySelector('.listBox_inner')
let delBtnEls = document.querySelectorAll('.delBtn')
let listEls = document.querySelectorAll('.list')
let allBtn = document.querySelector('.btn-all')
let beforeBtn = document.querySelector('.btn-before')
let afterBtn = document.querySelector('.btn-after')
let listCheck = document.querySelectorAll('.listCheck');
let allDel = document.querySelector('.allDel')
let allSelect = document.querySelector('.allSelect')


// ë¦¬ìŠ¤íŠ¸ ì¶”ê°€1 - 'enter'ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ê¸°
addTxt.addEventListener('keyup', function(e) {

    if(e.key === 'Enter') {
        addList()
    }

    checkList()
    delList()
    listCount()

})


// ë¦¬ìŠ¤íŠ¸ ì¶”ê°€2 - ì¶”ê°€(+)ë²„íŠ¼ìœ¼ë¡œ ì¶”ê°€í•˜ê¸°
addBtn.addEventListener('click', function() {

    addList()
    checkList()
    delList()
    listCount()

});


document.addEventListener('DOMContentLoaded', function() {
  checkList();
  });

// addTxt ì…ë ¥ì°½ nullê°’ íŒë‹¨
function addList() {
    if (addTxt.value !== "") {
        // listë¥¼ ì¶œë ¥í•  <div> ìš”ì†Œìƒì„±
        let list = document.createElement('div');
        list.setAttribute("class", "list");
        list.innerHTML = `<label class="listLb"><input type="checkbox" class="listCheck">${addTxt.value}</label><button class="delBtn">x</button>`;

        //urlì—ì„œ challengeId ê°€ì ¸ì˜¤ê¸°
         function getChallengeIdFromUrl() {
            var pathArray = window.location.pathname.split('/');
            return pathArray[pathArray.length - 1]; // Get the last segment of the path
        }

        var userNick = /*[[${userNick}]]*/ '';
        var challengeId = parseInt(getChallengeIdFromUrl(), 10);

        // ì‘ì„±í•œ ë‚´ìš© controllerì˜ add-todoì— ì „ì†¡
        fetch('/add-todo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userNick: userNick,
                challengeId: challengeId,
                todoText: addTxt.value
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log(data); // Response from the backend
        })
        .catch(error => {
            console.error('Error:', error);
        });

        listBox_inner.appendChild(list);
        addTxt.value = '';
        addTxt.style.borderBottom = '1px solid rgb(163, 155, 155)';

        if (document.querySelector('.notice')) {
            // ê²½ê³  ë©”ì‹œì§€ <div>ê°€ ìƒì„±ë˜ì–´ìˆëŠ” ê²½ìš° - ìš”ì†Œì‚­ì œ(removeChild)
            addBox = document.querySelector('.addBox');
            let notice = document.querySelector('.notice');
            addBox.removeChild(notice);
        }

    } else {

        // í…ìŠ¤íŠ¸ ë¯¸ì…ë ¥ì‹œ ê²½ê³  ë©”ì‹œì§€ ì¶œë ¥í•  <div> ìš”ì†Œìƒì„±
        let noticeEl = document.createElement('div');
        noticeEl.setAttribute('class', 'notice');
        noticeEl.innerHTML = '<span>* ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</span>';

        addTxt.style.borderBottom = '1px solid rgb(201, 65, 65)';

        if (document.querySelector('.notice')) {
            // ê²½ê³  ë©”ì‹œì§€ <div>ê°€ ìƒì„±ë˜ì–´ìˆëŠ” ê²½ìš°
        } else {
            // ê²½ê³  ë©”ì‹œì§€ <div>ê°€ ìƒì„±ë˜ì–´ìˆì§€ ì•Šì€ ê²½ìš° - ìš”ì†Œì¶”ê°€(appendChild)
            addBox = document.querySelector('.addBox');
            addBox.appendChild(noticeEl);
        }
    }
}



// ë¦¬ìŠ¤íŠ¸ ì²´í¬(ì™„ë£Œì²˜ë¦¬)
function checkList() {
    const listCheck = document.querySelectorAll('.listCheck');
    const listLb = document.querySelectorAll('.listLb');
    const currentUser = document.querySelector('.currentUser');
    const incompleteTasks = currentUser.querySelectorAll('.incomplete-task');

    listCheck.forEach((listEl, index) => {
        listEl.addEventListener('click', function () {
            console.log('Clicked:', listEl.checked);
            const checked = listEl.checked;
            const listItem = listEl.closest('li');
            const details = incompleteTasks[index].textContent;

            if (listEl.checked) {
                 listLb[index].style.textDecoration = "line-through";
                 updateCompleteStatus(details, true);
             } else {
                  listLb[index].style.textDecoration = "none";
                  updateCompleteStatus(details, false);
              }

                listCount();
        });
    });
}


async function updateCompleteStatus(details, checked) {
    function getChallengeIdFromUrl() {
            var pathArray = window.location.pathname.split('/');
            return pathArray[pathArray.length - 1];
        }

    const challengeId = getChallengeIdFromUrl();

    try {
        const response = await fetch(`/update-complete/${challengeId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                details: details,
                checked: checked
            })
        });

        const data = await response.json();
        console.log(data); // Response from the backend
    } catch (error) {
        console.error('Error:', error);
    }
}


// ë¦¬ìŠ¤íŠ¸ ì‚­ì œ
function delList() {

    delBtnEls = document.querySelectorAll('.delBtn')
    listEls = document.querySelectorAll('.list')

    delBtnEls.forEach((delEl, index) => delEl.addEventListener('click', function() {

        listEls[index].remove()

    }))

    listCount()

}


// ì „ì²´ì¡°íšŒ
allBtn.addEventListener('click', function() {

    // document.querySelector('.listBox_inner').textContent = ""
    // console.log(document.querySelector('.listBox_inner'))

    listEls = document.querySelectorAll('.list')

    listEls.forEach(listEl => {
        listEl.style.display = ""
    });

})


// ì§„í–‰ì¤‘ ì¡°íšŒ
beforeBtn.addEventListener('click', function() {

    listEls = document.querySelectorAll('.list')

    for(let i=0; i<listCheck.length; i++) {

        if(listCheck[i].checked == true) {
            listEls[i].style.display = "none"
        } else {
            listEls[i].style.display = ""
        }
    }

})


// ì™„ë£Œ ì¡°íšŒ
afterBtn.addEventListener('click', function() {

    listEls = document.querySelectorAll('.list')

    for(let i=0; i<listEls.length; i++) {
        if(listCheck[i].checked == true) {
            listEls[i].style.display = ""
        } else {
            listEls[i].style.display = "none"
        }
    }

})


// ì¡°íšŒ ê±´ìˆ˜
function listCount() {

    let beforeArray = [];
    let afterArray = [];

    // ì „ì²´
    listEls = document.querySelectorAll('.list')

    for(let i=0; i<listEls.length; i++) {   // listCheckë¡œ ë°›ìœ¼ë ¤ë©´ ì¬í• ë‹¹ ëª…ì‹œí•´ì¤˜ì•¼í•¨

        if(listCheck[i].checked == false) {
            // ì§„í–‰ì¤‘
            beforeArray.push(listEls[i])
        }  else {
            // ì™„ë£Œ
            afterArray.push(listEls[i])
        }
    }

    let beforeCount = beforeArray.length
    let afterCount = afterArray.length
    let allCount = beforeCount + afterCount

    allBtn.value = 'ì „ì²´ : ' + allCount
    beforeBtn.value =  'ì§„í–‰ì¤‘ : ' + beforeCount
    afterBtn.value = 'ì™„ë£Œ : ' + afterCount

}


// ì „ì²´ì„ íƒ
allSelect.addEventListener('click', function() {

    listCheck = document.querySelectorAll('.listCheck')
    listLb = document.querySelectorAll('.listLb')

    if(allSelect.checked == true) { // ì „ì²´ì„ íƒ ì²´í¬

        for(let i=0; i<listCheck.length; i++) {
            listCheck[i].checked = true;
            listLb[i].style.textDecoration = "line-through"
        }

    } else {    // ì „ì²´ì„ íƒ í•´ì œ

        for(let i=0; i<listCheck.length; i++) {
            listCheck[i].checked = false;
            listLb[i].style.textDecoration = "none"
        }

    }

    listCount()

})



// ì „ì²´ì‚­ì œ
allDel.addEventListener('click', function() {

    listBox_inner.innerHTML = ''
    allSelect.checked = false
    listCount()

})

</script>
</html>